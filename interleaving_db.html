<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caesar Cipher Practice (Final Version)</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti library for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom font and gradient background */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f9ff;
        }
        /* Shake animation for incorrect answers */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
        /* Styling for the Encrypt/Decrypt toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80; /* green-400 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80; /* green-400 */
        }
        /* Styling for the progress dots */
        .progress-dot {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: #e5e7eb; /* gray-200 */
            transition: background-color 0.3s ease-in-out;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-dot.completed {
            background-color: #4ade80; /* green-400 */
            box-shadow: 0 0 8px rgba(74, 222, 128, 0.7);
        }
        /* Scrollbar styling for leaderboard */
        #leaderboard-body::-webkit-scrollbar {
            width: 8px;
        }
        #leaderboard-body::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        #leaderboard-body::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        #leaderboard-body::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Disabled button style */
        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Nickname Modal -->
    <div id="nicknameModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">æ­¡è¿æŒ‘æˆ°ï¼</h2>
            <p class="mb-6 text-gray-600">
                è«‹è¼¸å…¥ä½ çš„ã€Œç­ç´šåº§è™Ÿ+å§“åã€<br>ç¯„ä¾‹: 70135 æé˜¿å“²
            </p>
            <input type="text" id="nicknameInput" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg text-center focus:ring-2 focus:ring-blue-500" placeholder="ä½ çš„ç­ç´šåº§è™Ÿå§“å..." maxlength="15">
            <button onclick="saveNicknameAndStart()" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 rounded-lg text-lg hover:bg-blue-700 transition">é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <!-- Main Card Container -->
    <div id="card" class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl p-6 md:p-10 text-center transition-transform duration-500 hidden">
        <div id="designedBy" class="absolute top-4 right-4 text-xs text-gray-400">Sljsæ°´æ—åœ‹ä¸­è³‡è¨Šç§‘æŠ€-by WEI</div>
        
        <h1 class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">Caesar Cipher Practice</h1>
        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-6">å‡±æ’’å¯†ç¢¼ (å­—æ¯ä½ç§»æ³•)</h2>
        
        <div class="flex flex-col md:flex-row gap-8 mt-6">

            <!-- Left Panel: Main Game Area -->
            <div class="flex-grow text-center">
                <!-- Mode Toggle: Encrypt / Decrypt -->
                <div class="flex items-center justify-center space-x-4 mb-6">
                    <span class="font-semibold text-lg text-gray-600">åŠ å¯† (Encrypt)</span>
                    <div class="relative inline-block w-14 h-8 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="modeToggle" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="modeToggle" class="toggle-label block overflow-hidden h-8 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <span class="font-semibold text-lg text-gray-600">è§£å¯† (Decrypt)</span>
                </div>

                <!-- Dynamic text to be encrypted/decrypted -->
                <p class="text-lg text-gray-500 mb-2" id="textLabel">Original Text:</p>
                <div id="originalText" class="text-4xl md:text-5xl font-bold text-indigo-600 tracking-widest bg-gray-100 p-4 rounded-lg mb-4"></div>
                <p class="text-lg">
                    <span class="font-semibold text-gray-700">Shift Value (ä½ç§»å€¼):</span>
                    <span id="shiftValue" class="text-2xl font-bold text-red-500 ml-2 bg-red-100 px-3 py-1 rounded-full"></span>
                </p>
                <button onclick="toggleAlphabetHelper()" class="my-4 text-blue-500 hover:text-blue-700 font-semibold">
                    é¡¯ç¤º/éš±è—å­—æ¯å°ç…§è¡¨
                </button>
                <div id="alphabetHelper" class="hidden bg-blue-50 p-4 rounded-lg text-left overflow-x-auto">
                    <p class="font-mono text-lg md:text-xl whitespace-nowrap" id="alphabetRow"></p>
                    <p class="font-mono text-lg md:text-xl whitespace-nowrap mt-2" id="lowercaseAlphabetRow"></p>
                    <p class="font-mono text-lg md:text-xl whitespace-nowrap mt-2" id="numberRow"></p>
                </div>
                <div class="mt-6">
                    <label for="studentInput" id="inputLabel" class="block text-lg font-semibold text-gray-700 mb-2">Enter Encrypted Text:</label>
                    <input type="text" id="studentInput" class="w-full max-w-md mx-auto p-3 border-2 border-gray-300 rounded-lg text-xl text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div class="mt-6">
                    <button id="checkAnswerBtn" onclick="checkAnswer()" class="w-full max-w-xs bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
                        Check Answer
                    </button>
                    <p id="result" class="mt-4 text-lg font-semibold min-h-[5em]"></p>
                </div>
            </div>

            <!-- Right Panel: Progress Tracker & Leaderboard -->
            <div class="md:w-2/5 flex-shrink-0 bg-gray-50 p-6 rounded-lg border">
                <h3 class="text-xl font-semibold text-center mb-6 text-gray-700">æŒ‘æˆ°é€²åº¦</h3>
                <div class="flex justify-between items-center mb-6 text-lg bg-white p-3 rounded-md shadow-sm">
                    <p id="levelDisplay" class="font-bold text-gray-700">åŠ å¯† 1 / 5</p>
                    <p id="timer" class="font-bold text-gray-500">Time: 0s</p>
                </div>
                <div class="mb-6">
                    <span class="font-semibold text-gray-600 text-lg">åŠ å¯†</span>
                    <div id="encryptProgress" class="flex justify-between mt-2 px-2">
                        <div class="progress-dot"></div><div class="progress-dot"></div><div class="progress-dot"></div><div class="progress-dot"></div><div class="progress-dot"></div>
                    </div>
                </div>
                <div class="mb-6">
                    <span class="font-semibold text-gray-600 text-lg">è§£å¯†</span>
                    <div id="decryptProgress" class="flex justify-between mt-2 px-2">
                        <div class="progress-dot"></div><div class="progress-dot"></div><div class="progress-dot"></div><div class="progress-dot"></div><div class="progress-dot"></div>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                    <span class="font-semibold text-gray-600 text-lg">ç¸½æŒ‘æˆ°æ¬¡æ•¸</span>
                    <p id="attemptsDisplay" class="font-bold text-2xl text-blue-600 mt-2">0</p>
                </div>

                <!-- Leaderboard -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 id="leaderboardTitle" class="text-xl font-semibold text-center mb-4 text-gray-700">å³æ™‚æ’è¡Œæ¦œ</h3>
                    <div class="bg-white rounded-lg shadow-inner">
                        <div id="leaderboard-header" class="grid grid-cols-4 gap-2 text-center font-semibold text-xs text-gray-500 p-2 border-b">
                            <div>æ’å</div>
                            <div class="col-span-2">ç©å®¶</div>
                            <div>æ¬¡æ•¸</div>
                        </div>
                        <div id="leaderboard-body" class="max-h-48 overflow-y-auto">
                            <!-- Leaderboard rows will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports (No Auth needed anymore)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Config ---
        const game = {
            encryptLevel: 1,
            decryptLevel: 1,
            totalLevels: 5,
            timeElapsed: 0,
            timerInterval: null,
            timerRunning: false,
            currentText: '',
            correctAnswer: '',
            currentShift: 0,
            isDecryptMode: false,
            totalAttempts: 0,
            userId: null, // Will be generated locally
            nickname: '',
            elements: {
                card: document.getElementById('card'),
                originalText: document.getElementById('originalText'),
                shiftValue: document.getElementById('shiftValue'),
                studentInput: document.getElementById('studentInput'),
                result: document.getElementById('result'),
                timer: document.getElementById('timer'),
                levelDisplay: document.getElementById('levelDisplay'),
                modeToggle: document.getElementById('modeToggle'),
                textLabel: document.getElementById('textLabel'),
                inputLabel: document.getElementById('inputLabel'),
                alphabetHelper: document.getElementById('alphabetHelper'),
                alphabetRow: document.getElementById('alphabetRow'),
                lowercaseAlphabetRow: document.getElementById('lowercaseAlphabetRow'),
                numberRow: document.getElementById('numberRow'),
                encryptProgress: document.getElementById('encryptProgress'),
                decryptProgress: document.getElementById('decryptProgress'),
                attemptsDisplay: document.getElementById('attemptsDisplay'),
                nicknameModal: document.getElementById('nicknameModal'),
                nicknameInput: document.getElementById('nicknameInput'),
                leaderboardBody: document.getElementById('leaderboard-body'),
                leaderboardTitle: document.getElementById('leaderboardTitle'),
                checkAnswerBtn: document.getElementById('checkAnswerBtn'),
            }
        };

        // --- Firebase Config ---
        let db;
        const firebaseConfig = {
            apiKey: "AIzaSyCIetB78_g-W4d9FgHRX96cWV2Jw4w-lcE",
            authDomain: "caesar-cipher-game.firebaseapp.com",
            projectId: "caesar-cipher-game",
            storageBucket: "caesar-cipher-game.appspot.com",
            messagingSenderId: "654107462649",
            appId: "1:654107462649:web:8d0512e8b5bf9b19714b28"
        };
       
        // --- Firebase Initialization ---
        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setLogLevel('error');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.querySelector("#leaderboard-body").innerHTML = `<p class="text-center text-red-500 p-4">æ’è¡Œæ¦œé€£ç·šå¤±æ•—</p>`;
                return false;
            }
            return true;
        }
        
        // --- Local User ID Generation ---
        function getOrSetUserId() {
            let userId = localStorage.getItem('caesarCipherUserId');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('caesarCipherUserId', userId);
            }
            game.userId = userId;
        }

        // --- Core Logic ---
        function caesarCipher(text, shift) {
            const processChar = (char, baseCode, range) => {
                let charCode = char.charCodeAt(0);
                let newCode = (charCode - baseCode + shift) % range;
                if (newCode < 0) newCode += range;
                return String.fromCharCode(newCode + baseCode);
            };
            let result = '';
            for (let i = 0; i < text.length; i++) {
                let char = text.charAt(i);
                if (char >= 'a' && char <= 'z') result += processChar(char, 'a'.charCodeAt(0), 26);
                else if (char >= 'A' && char <= 'Z') result += processChar(char, 'A'.charCodeAt(0), 26);
                else if (char >= '0' && char <= '9') result += processChar(char, '0'.charCodeAt(0), 10);
                else result += char;
            }
            return result;
        }
        
        function generateRandomString(length = 6) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // --- Game Flow ---
        function setupNewRound() {
            game.elements.studentInput.value = '';
            game.elements.result.innerHTML = '';
            game.elements.card.classList.remove('shake');
            game.isDecryptMode = game.elements.modeToggle.checked;
            
            let currentLevel, modeName;
            if (game.isDecryptMode) {
                currentLevel = game.decryptLevel;
                modeName = 'è§£å¯†';
            } else {
                currentLevel = game.encryptLevel;
                modeName = 'åŠ å¯†';
            }

            const allLevelsCompleted = currentLevel > game.totalLevels;
            game.elements.levelDisplay.innerText = `${modeName} ${Math.min(currentLevel, game.totalLevels)} / ${game.totalLevels}`;

            if (allLevelsCompleted) {
                game.elements.originalText.innerText = "ğŸ‰";
                game.elements.shiftValue.innerText = "-";
                game.elements.result.innerHTML = `<span class="text-green-600">${modeName}æ¨¡å¼å·²å…¨æ•¸é€šé—œï¼</span>`;
                game.elements.studentInput.disabled = true;
                game.elements.checkAnswerBtn.disabled = true;
                stopTimer();
                return;
            }
            
            game.elements.studentInput.disabled = false;
            game.elements.checkAnswerBtn.disabled = false;
            game.currentShift = ((currentLevel - 1) % 4) + 2;
            const randomText = generateRandomString();
            
            if (game.isDecryptMode) {
                game.currentText = caesarCipher(randomText, game.currentShift);
                game.correctAnswer = randomText;
                game.elements.textLabel.innerText = "Encrypted Text (å¯†æ–‡):";
                game.elements.inputLabel.innerText = "Enter Decrypted Text (è¼¸å…¥è§£é–‹çš„æ˜æ–‡):";
            } else {
                game.currentText = randomText;
                game.correctAnswer = caesarCipher(randomText, game.currentShift);
                game.elements.textLabel.innerText = "Original Text (æ˜æ–‡):";
                game.elements.inputLabel.innerText = "Enter Encrypted Text (è¼¸å…¥åŠ å¯†å¾Œçš„å¯†æ–‡):";
            }
            
            game.elements.originalText.innerText = game.currentText;
            game.elements.shiftValue.innerText = game.currentShift;
            updateAlphabetHelper();
            resetTimer();
            startTimer();
        }

        window.checkAnswer = function() {
            const studentAnswer = game.elements.studentInput.value;
            if (!studentAnswer || game.elements.studentInput.disabled) return;
            
            // Disable controls immediately to prevent spamming
            game.elements.studentInput.disabled = true;
            game.elements.checkAnswerBtn.disabled = true;

            game.totalAttempts++;
            game.elements.attemptsDisplay.innerText = game.totalAttempts;
            updatePlayerScoreInFirestore();

            if (studentAnswer === game.correctAnswer) {
                handleCorrectAnswer();
            } else {
                handleIncorrectAnswer(studentAnswer);
            }
        }
        
        function handleCorrectAnswer() {
            stopTimer();
            // Controls are already disabled from checkAnswer

            if (game.isDecryptMode) {
                if (game.decryptLevel <= game.totalLevels) game.decryptLevel++;
            } else {
                if (game.encryptLevel <= game.totalLevels) game.encryptLevel++;
            }
            updateProgressUI();
            updatePlayerScoreInFirestore();
            game.elements.result.innerHTML = '<span class="text-green-600">Correct! Well done. (æ­£ç¢ºï¼)</span>';
            launchConfetti();
            setTimeout(setupNewRound, 2000);
        }

        function handleIncorrectAnswer(studentAnswer) {
            stopTimer();
            // Controls are already disabled from checkAnswer
            game.elements.card.classList.add('shake');
            let feedback = `<span class="text-red-600">Incorrect. (ä¸æ­£ç¢º)</span><br><br>Correct Answer (æ­£ç¢ºç­”æ¡ˆ):<br><strong class="text-blue-600 font-mono">${game.correctAnswer}</strong><br><br>Your Answer (ä½ çš„ç­”æ¡ˆ):<br>`;
            let highlightedAnswer = '';
            for(let i=0; i < game.correctAnswer.length; i++) {
                if(i >= studentAnswer.length || studentAnswer[i] !== game.correctAnswer[i]) {
                    highlightedAnswer += `<span class="text-red-500 bg-red-100 rounded px-1">${studentAnswer[i] || '_'}</span>`;
                } else {
                    highlightedAnswer += `<span class="text-green-600">${studentAnswer[i]}</span>`;
                }
            }
            feedback += `<strong class="font-mono">${highlightedAnswer}</strong><br><br><span class="text-gray-500 italic">3ç§’å¾Œå°‡å‡ºç¾æ–°é¡Œç›®...</span>`;
            game.elements.result.innerHTML = feedback;
            setTimeout(setupNewRound, 3000);
        }
        
        // --- UI & Helpers ---
        function updateProgressUI() {
            const updateDots = (progressElement, completedLevel) => {
                const dots = progressElement.children;
                for (let i = 0; i < dots.length; i++) {
                    dots[i].classList.toggle('completed', i < completedLevel - 1);
                }
            };
            updateDots(game.elements.encryptProgress, game.encryptLevel);
            updateDots(game.elements.decryptProgress, game.decryptLevel);
        }

        function launchConfetti() {
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        }
        
        function updateAlphabetHelper() {
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const lowercaseAlphabet = "abcdefghijklmnopqrstuvwxyz";
            const numbers = "0123456789";
            game.elements.alphabetRow.innerText = `Uppercase: ${alphabet}`;
            game.elements.lowercaseAlphabetRow.innerText = `Lowercase: ${lowercaseAlphabet}`;
            game.elements.numberRow.innerText =  `Numbers:   ${numbers}`;
        }
        window.toggleAlphabetHelper = toggleAlphabetHelper;
        function toggleAlphabetHelper() {
            game.elements.alphabetHelper.classList.toggle('hidden');
        }

        // --- Timer ---
        function startTimer() {
            if (!game.timerRunning) {
                game.timerRunning = true;
                game.timerInterval = setInterval(() => {
                    game.timeElapsed++;
                    game.elements.timer.innerText = `Time: ${game.timeElapsed}s`;
                }, 1000);
            }
        }
        function stopTimer() { clearInterval(game.timerInterval); game.timerRunning = false; }
        function resetTimer() { stopTimer(); game.timeElapsed = 0; game.elements.timer.innerText = "Time: 0s"; }
        
        // --- Leaderboard ---
        function listenForLeaderboardUpdates() {
            if (!db) return; 
            try {
                const year = new Date().getFullYear();
                const leaderboardCollectionName = `leaderboard-${year}`;
                game.elements.leaderboardTitle.innerText = `${year} å³æ™‚æ’è¡Œæ¦œ`;

                const appId = "caesar-cipher-game-leaderboard";
                const leaderboardCollection = collection(db, `/artifacts/${appId}/public/data/${leaderboardCollectionName}`);
                
                onSnapshot(leaderboardCollection, (snapshot) => {
                    const players = [];
                    snapshot.forEach(doc => players.push({ id: doc.id, ...doc.data() }));

                    players.sort((a, b) => {
                        const scoreA = (a.encryptLevel - 1) + (a.decryptLevel - 1);
                        const scoreB = (b.encryptLevel - 1) + (b.decryptLevel - 1);
                        if (scoreB !== scoreA) return scoreB - scoreA;
                        return a.totalAttempts - b.totalAttempts;
                    });

                    renderLeaderboard(players);
                }, (error) => {
                    console.error("Leaderboard snapshot error:", error);
                    game.elements.leaderboardBody.innerHTML = `<p class="text-center text-red-500 p-4">æ’è¡Œæ¦œè®€å–éŒ¯èª¤ã€‚è«‹æª¢æŸ¥å®‰å…¨è¦å‰‡ã€‚</p>`;
                });
            } catch (error) {
                console.error("Failed to set up leaderboard listener:", error);
                game.elements.leaderboardBody.innerHTML = `<p class="text-center text-red-500 p-4">ç„¡æ³•è¨­å®šæ’è¡Œæ¦œç›£è½ã€‚</p>`;
            }
        }
        
        function renderLeaderboard(players) {
            game.elements.leaderboardBody.innerHTML = '';
            if (players.length === 0) {
                game.elements.leaderboardBody.innerHTML = '<p class="text-center text-gray-500 p-4">é‚„æ²’æœ‰äººä¸Šæ¦œï¼Œå¿«ä¾†æ¶é ­é¦™ï¼</p>';
                return;
            }
            players.forEach((player, index) => {
                const isCurrentUser = player.id === game.userId;
                const rank = index + 1;
                const row = document.createElement('div');
                row.className = `grid grid-cols-4 gap-2 text-center items-center p-2 text-sm ${isCurrentUser ? 'bg-blue-100 font-bold' : ''}`;
                
                const progressDotsHTML = (level) => {
                    let dots = '';
                    for (let i = 0; i < game.totalLevels; i++) {
                        dots += `<div class="w-3 h-3 rounded-full inline-block mx-0.5 ${i < level - 1 ? 'bg-green-400' : 'bg-gray-200'}"></div>`;
                    }
                    return dots;
                };

                row.innerHTML = `
                    <div>${rank}</div>
                    <div class="col-span-2 text-left truncate">
                        <p>${player.nickname || 'åŒ¿åç©å®¶'}</p>
                        <div class="text-xs">
                            <span class="font-semibold">åŠ :</span> ${progressDotsHTML(player.encryptLevel)}
                        </div>
                        <div class="text-xs">
                            <span class="font-semibold">è§£:</span> ${progressDotsHTML(player.decryptLevel)}
                        </div>
                    </div>
                    <div>${player.totalAttempts}</div>
                `;
                game.elements.leaderboardBody.appendChild(row);
            });
        }
        
        async function updatePlayerScoreInFirestore() {
            if (!db || !game.userId || !game.nickname) return;
            const year = new Date().getFullYear();
            const leaderboardCollectionName = `leaderboard-${year}`;
            const appId = "caesar-cipher-game-leaderboard";
            const playerDocRef = doc(db, `/artifacts/${appId}/public/data/${leaderboardCollectionName}`, game.userId);
            const playerData = {
                nickname: game.nickname,
                encryptLevel: game.encryptLevel,
                decryptLevel: game.decryptLevel,
                totalAttempts: game.totalAttempts,
                lastUpdated: serverTimestamp()
            };
            try {
                await setDoc(playerDocRef, playerData, { merge: true });
            } catch (error) {
                console.error("Failed to update score:", error);
            }
        }
        
        // --- Nickname and Game Start ---
        window.saveNicknameAndStart = function() {
            const nickname = game.elements.nicknameInput.value.trim();
            if (nickname) {
                game.nickname = nickname;
                localStorage.setItem(`cipher_nickname`, nickname);
                game.elements.nicknameModal.classList.add('hidden');
                game.elements.card.classList.remove('hidden');
                updatePlayerScoreInFirestore();
                setupNewRound();
                updateProgressUI();
                game.elements.attemptsDisplay.innerText = game.totalAttempts;
            } else {
                alert('è«‹è¼¸å…¥ä¸€å€‹æš±ç¨±ï¼');
            }
        }
        
        // --- Initial Load ---
        function main() {
            const firebaseReady = initFirebase();
            getOrSetUserId();

            const savedNickname = localStorage.getItem(`cipher_nickname`);
            if (savedNickname) {
                game.nickname = savedNickname;
                game.elements.nicknameModal.classList.add('hidden');
                game.elements.card.classList.remove('hidden');
                setupNewRound();
                updateProgressUI();
                game.elements.attemptsDisplay.innerText = game.totalAttempts;
            }

            if (firebaseReady) {
                listenForLeaderboardUpdates();
            }
        }

        window.onload = main;

        game.elements.modeToggle.addEventListener('change', setupNewRound);
        game.elements.studentInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') checkAnswer();
        });
        game.elements.nicknameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') saveNicknameAndStart();
        });
    </script>
</body>
</html>

